<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scroller</title>
</head>
<body>
<h1>Lorem ipsum dolor sit amet</h1>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
<div class="hpmdn-wrapper">
    <div class="hpmdn-scroller">
        <div class="hpmdn-scroller-part hpmdn-scroller-part1"></div>
        <div class="hpmdn-scroller-part hpmdn-scroller-part2"></div>
        <div class="hpmdn-scroller-part hpmdn-scroller-part3"></div>
    </div>
</div>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero? Lorem ipsum dolor sit amet, consectetur adipisicing elit. Commodi ducimus ea iste laborum
    minima nemo
    nesciunt perspiciatis praesentium rem soluta. At cupiditate deserunt eligendi facilis magnam nostrum
    obcaecati porro vero?</p>
</body>

<style>
    html {
        width: 100%;
    }

    body {
        width: 70%;
        margin: 0 auto;
        font: normal 14px sans-serif;
    }

    .hpmdn-wrapper {
        width: 100%;
        background: #dffcc5;
        position: relative;
        overflow: hidden;
    }

    .hpmdn-mask {
        /* Задаем позицию маске */
        position: absolute;
        top: 0;
        left: 0;
        /* Ограничиваем область видимости. Работает только на ios */
        overflow: hidden;
        width: 100%;
        /* Bugfix для Android */
        z-index: 1;
    }

    .hpmdn-scroller {
        /* Задаем фиксированное позиционирование
                          * и прибиваем элемент к нижниму левому углу */
        position: absolute;
        height: 100vh;
        left: 0;
        top: 0;
        width: 100%;
        /* Фоновая картинка */
        background-color: white;
        /* Масштабирует изображение с сохранением пропорций так, чтобы его ширина или высота равнялась ширине или высоте блока */
        background-size: cover;
        /* Отключаем обработку тапов по элементу.
           Это дает нам горантию того, что невидимая часть scroller-а не будет реагировать на действия пользователя.*/
        pointer-events: none;
        box-sizing: content-box !important;
        /* Bugfix для IOs. Включаем GPU acceleration */
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        display: flex;
        flex-direction: column;
    }

    .hpmdn-scroller-part1,
    .hpmdn-scroller-part2,
    .hpmdn-scroller-part3 {
        width: 100%;
    }

    .hpmdn-scroller-part1 {
        background-color: lightpink;
        height: 25%;
    }

    .hpmdn-scroller-part2 {
        background-color: lightskyblue;
        height: 50%;
    }

    .hpmdn-scroller-part3 {
        background-color: lightsalmon;
        height: 25%;
    }
</style>
<script>
    var onViewportUpdate = function () {
        setScrollerSize();
        var width = mask.offsetWidth;
        mask.style.height = width * 0.45 + 'px';
        scrollerHandler();
  };

  /* В этих переменных мы храним последнюю зарегестрированную высоту экрана */
  var lastHeight = 0, height = window.innerHeight, rect;
    var wrapper = container.querySelector('.hpmdn-wrapper');
    // Сохраняем ссылку на фон-подложку
    var scroller = container.querySelector('.hpmdn-scroller');

    var scrollerPartLeft  = container.querySelector('.hpmdn-scroller-part-left');
    var scrollerPartRight = container.querySelector('.hpmdn-scroller-part-right');
    // Сохраняем ссылку на маску
    var mask = container.querySelector('.hpmdn-mask');

  /* Функция обновления размеров фона-подложки */
  var setScrollerSize = function () {
    // Задаем размеры скроллера
    // Если высота изменилась
    if (lastHeight != window.innerHeight) {

      // Регестрируем новую высоту экрана
      height = window.innerHeight;
      lastHeight = height;
      // Обновляем ширину баннера
      scroller.style.width = container.clientWidth + "px";
      // Обновляем высоту баннера
      // hpmd.scroller.headerHeight() - системная функция.
      // Она возвращает высоту фиксированного хедера на странице, если он есть
      console.log(hpmd.scroller.headerHeight())
      // scroller.style.height = (height - hpmd.scroller.headerHeight()) + "px";
      scroller.style.height = mask.offsetWidth * 1.35 + 'px';
      // Устанавливаем отступ слева
      // if (!!container) {
      // rect = container.getBoundingClientRect();
      // scroller.style.left = rect.left + 'px';
      // }
    }
  };

  // Проверяем обновление размеров экрана каждые 100 мсек
  setInterval(function () {
    onViewportUpdate();
  }, 100);

  function getCSSPropValue(elem) {
    var styles = getComputedStyle(elem);
    return function (prop) {
      return parseFloat(styles.getPropertyValue(prop));
    }
  }

  function getSlotMargins() {
    var getValue = getCSSPropValue(container.parentNode);
    return getValue('margin-bottom') +
      getValue('margin-top') +
      getValue('padding-bottom') +
      getValue('padding-top');
  }

  function setTransform(elem, value) {
    elem.style.msTransform = value;
    elem.style.webkitTransform = value;
    elem.style.MozTransform = value;
    elem.style.OTransform = value;
    elem.style.transform = value;
  }

  function scrollerHandler() {
    var rect = container.getBoundingClientRect();
    var margins = getSlotMargins();
    var offset = -(scroller.offsetHeight - mask.offsetHeight) / 2 / mask.offsetHeight * 100;
    var percent = (
      (rect.top + rect.height / 2)
    ) / window.innerHeight - .5;

    scroller.style.top = (offset) + '%';

    setTransform(scrollerPartLeft, 'translate3d(0%, ' + (100 * percent) + '%, 0)');
    setTransform(scrollerPartRight, 'translate3d(0%, ' + (-100 * percent) + '%, 0)');
  }

  /**
   * Ожидаем появления баннера на экране
   *
   * Код нативных баннеров запускается при загрузке страницы, но начинают работать
   * они только тогда, когда появятся на экране после скролла пользователя. Переданный
   * функции hpmd.ready() обработчик будет вызван, когда баннер должен начать работу.
   */
  // hpmd.ready(function () {
  hpmd.data.processNode(container.parentNode);
  // Баннер появился на экране

  /* При "тапе" на баннер открываем ссылку и закрываем баннер */
  hpmd.data.handleClick(wrapper, function () {
    hpmd.data.closeBanner();
    hpmd.link();
  });

  window.addEventListener('scroll', scrollerHandler);
  scrollerHandler();
  // });
  let elements = {
    wrapper: undefined,
    scroller: undefined,
    scrollerParts: undefined
  };
  const getElements = function () {
    elements.wrapper = document.querySelector('.hpmdn-wrapper');
    elements.scroller = document.querySelector('.hpmdn-scroller');
    elements.scrollerParts = document.querySelectorAll('.hpmdn-scroller-part');
  };
  const getContainerSize = function () {
    if (elements.wrapper) {
      const widthElem = parseInt(getComputedStyle(document.body, null).width);
      elements.wrapper.style.width = widthElem + 'px';
      elements.wrapper.style.height = widthElem * 0.5625 + 'px';
      // elements.scrollerParts[1].style.height = widthElem*0.5625 + 'px';
      // elements.scrollerParts[0].style.height = widthElem*0.5625 / 2 + 'px';
      // elements.scrollerParts[2].style.height = widthElem*0.5625 / 2 + 'px';
    }
  };
  const isVisible = function () {
    const viewportPosition = window.pageYOffset + window.innerHeight; //нижняя граница окна браузера
    //нижняя граница первого блока скроллера
    const elementPosition = elements.wrapper.getBoundingClientRect().y + elements.scrollerParts[0].getBoundingClientRect().height
    console.log('viewportPosition', viewportPosition)
    console.log('elementPosition', elementPosition)
    return viewportPosition >= elementPosition;
  };
  const isMainSlide = function () {
    return elements.wrapper.getBoundingClientRect().y === elements.scrollerParts[1].getBoundingClientRect().y &&
      elements.wrapper.getBoundingClientRect().y >= window.innerHeight / 3
  };
  const getDirection = function () {
    return (variables.yOffset - window.pageYOffset) > 0 ? 'up' : 'down'
  };
  let variables = {
    yOffset: window.pageYOffset,
    translateScroller: 0
  };
  window.onload = function () {
    getElements();
    getContainerSize();
    let yOffset = window.pageYOffset;
    let translateScroller = 0;
    document.addEventListener('scroll', function () {
      if (elements.wrapper.getBoundingClientRect().y === elements.scrollerParts[1].getBoundingClientRect().y) {
        console.log('TRUE')
      }
      let scrollerRect = elements.scroller.getBoundingClientRect();
      let wrapperRect = elements.wrapper.getBoundingClientRect();
      //условия движения вниз
      if (scrollerRect.y <= wrapperRect.y &&
        getDirection() === 'down' &&
        isVisible()) {
        elements.scroller.style.transform = 'translateY(' + (translateScroller + window.pageYOffset - yOffset) * (-0.5) + 'px)';
        translateScroller = translateScroller + window.pageYOffset - yOffset
        yOffset = window.pageYOffset;
      }
      //условия движения вверх
      if (scrollerRect.y <= wrapperRect.y &&
        (scrollerRect.y + scrollerRect.height) >= (wrapperRect.y + wrapperRect.height) &&
        isVisible()) {
        elements.scroller.style.transform = 'translateY(' + (translateScroller + window.pageYOffset - yOffset) * (-0.5) + 'px)';
        translateScroller = translateScroller + window.pageYOffset - yOffset
        yOffset = window.pageYOffset;
      }
    })
  }

</script>
</html>
